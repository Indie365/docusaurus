---
authors:
  - slorber
tags: [release]
slug: /upgrading-frontend-dependencies-with-confidence-using-visual-regression-testing
# image: ./img/social-card.png
---

# Upgrading frontend dependencies with confidence

Frontend developers need to keep their npm dependencies up to date. But those updates can feel scary, as they can lead to subtle unintended UI side effects that are not detected by your CI and your regular test suite.

Upgrading Docusaurus is a good example: without reviewing all the pages one by one, it's hard to be sure there's no visual regression. **Docusaurus v3 is around the corner**, and we would like to help you do this upgrade with confidence.

This article introduces a **visual regression testing** workflow based on [GitHub Actions](https://github.com/features/actions), [Playwright](https://playwright.dev/) and [Argos](https://argos-ci.com/). It is not directly coupled to Docusaurus, and can be adapted to work with other frontend applications and frameworks.

<!--truncate-->

This workflow has been tested while upgrading Docusaurus v2 to v3, and already helped catch a few visual regressions on sites such as [React-Native](https://reactnative.dev/), [Jest](https://jestjs.io/) and our [Docusaurus](https://docusaurus.io/) itself. Docusaurus v3 comes with infrastructure changes such as [MDX v2](https://mdxjs.com/blog/v2/) and [React 18](https://react.dev/blog/2022/03/29/react-v18), which can produce unintended side effects. It would have been hard to notice all the visual regressions without such workflow. For this reason I encourage site owners to consider adopting visual regression tests, in particular for highly customized sites.

## Workflow overview

The general idea is pretty simple:

- Build your site in CI with [GitHub Actions](https://github.com/features/actions)
- Take screenshots of all `sitemap.xml` pages with [Playwright](https://playwright.dev/)
- Upload them to [Argos](https://argos-ci.com/)
- Do this for both Git branches `main` and `pr-branch`
- Compare the screenshots side by side in [Argos](https://argos-ci.com/)

The outcome: a bot will report the visual differences found between `main` and `pr-branch` as a GitHub commit status and pull-request comment, helping you detect visual regressions ahead of time in an automated way.

![Argos GitHub commit status](./img/argos-github-status.png)

![Argos GitHub PR comment](./img/argos-github-comment.png)

Argos creates a report referencing all the visual differences found while comparing the 2 Git branches sites side by side, and provides an UX to easily identify which part of a page has changed.

Check the [Docusaurus Argos page](https://app.argos-ci.com/meta-open-source/docusaurus) to explore our own website reports.

Here is a more concrete example of Argos [reporting a visual regression](https://app.argos-ci.com/slorber/rnw-visual-tests/builds/32/56012838) found while upgrading the React-Native website:

![Argos GitHub PR comment](./img/argos-react-native-regression.png)

## Workflow implementation

This section will describe the implementation details of each step of the workflow.

### GitHub Actions

The GitHub action is responsible for executing the workflow for each Git branch.

A minimal action could look like:

```yaml title=".github/workflows/argos.yml"
name: Argos CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  take-screenshots:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build the website
        run: yarn docusaurus build

      - name: Take screenshots with Playwright
        run: yarn playwright test

      - name: Upload screenshots to Argos
        run: yarn argos upload ./screenshots
```

### Playwright

Playwright is responsible for taking screenshots of the website built locally by the GitHub action.

A minimal config could look like:

```ts title="playwright.config.ts"
import {devices} from '@playwright/test';
import type {PlaywrightTestConfig} from '@playwright/test';

/**
 * See https://playwright.dev/docs/test-configuration.
 */
const config: PlaywrightTestConfig = {
  webServer: {
    port: 3000,
    command: 'yarn docusaurus serve',
  },
  projects: [
    {
      name: 'chromium',
      use: {
        ...devices['Desktop Chrome'],
      },
    },
  ],
};

export default config;
```

But a config is not enough, and we also need to write a Playwright test file to generate the site screenshots.

```ts title="screenshot.spec.ts"
import * as fs from 'fs';
import {test} from '@playwright/test';
import {argosScreenshot} from '@argos-ci/playwright';
import {extractSitemapPathnames, pathnameToArgosName} from './utils';

// Constants:
const siteUrl = 'http://localhost:3000';
const sitemapPath = './build/sitemap.xml';
const stylesheetPath = './screenshot.css';
const stylesheet = fs.readFileSync(stylesheetPath).toString();

// Wait for hydration, requires Docusaurus v2.4.3+
// Docusaurus adds a <html data-has-hydrated="true"> once hydrated
// See https://github.com/facebook/docusaurus/pull/9256
function waitForDocusaurusHydration() {
  return document.documentElement.dataset.hasHydrated === 'true';
}

function screenshotPathname(pathname: string) {
  test(`pathname ${pathname}`, async ({page}) => {
    const url = siteUrl + pathname;
    await page.goto(url);
    await page.waitForFunction(waitForDocusaurusHydration);
    await page.addStyleTag({content: stylesheet});
    await argosScreenshot(page, pathnameToArgosName(pathname));
  });
}

test.describe('Docusaurus site screenshots', () => {
  const pathnames = extractSitemapPathnames(sitemapPath);
  console.log('Pathnames to screenshot:', pathnames);
  pathnames.forEach(screenshotPathname);
});
```

<details>
<summary>What's inside <code>utils.ts</code>?</summary>

```ts
import * as cheerio from 'cheerio';
import * as fs from 'fs';

// Extract a list of pathnames, given a fs path to a sitemap.xml file
// Docusaurus generates a build/sitemap.xml file for you!
export function extractSitemapPathnames(sitemapPath: string): string[] {
  const sitemap = fs.readFileSync(sitemapPath).toString();
  const $ = cheerio.load(sitemap, {xmlMode: true});
  const urls: string[] = [];
  $('loc').each(function handleLoc() {
    urls.push($(this).text());
  });
  return urls.map((url) => new URL(url).pathname);
}

// Converts a pathname to a decent screenshot name
export function pathnameToArgosName(pathname: string): string {
  function removeTrailingSlash(str: string): string {
    return str.endsWith('/') ? str.slice(0, -1) : str;
  }
  function removeLeadingSlash(str: string): string {
    return str.startsWith('/') ? str.slice(1) : str;
  }
  pathname = removeTrailingSlash(pathname);
  pathname = removeLeadingSlash(pathname);
  if (pathname === '') {
    return 'index';
  }
  return pathname;
}
```

</details>

:::warning Handling screenshot flakiness

Docusaurus screenshots are not always deterministic, and taking a screenshot of a page twice can lead to subtle variations that will be reported by Argos as false positive visual regressions.

For this reason we recommend using an extra stylesheet to hide the problematic elements. It is possible that you will need to add rules to this base stylesheet, according to the flaky elements found on your own site. Read [Argos - About flaky tests docs](https://argos-ci.com/docs/about-flaky) for details.

```css title="screenshot.css"
/* Iframes can load lazily */
iframe,
/* Avatar images can be flaky due to using external sources: GitHub/Unavatar */
.avatar__photo,
/* Gifs load lazily and are animated */
img[src$='.gif'],
/* Algolia Keyboard shortcuts appear with a little delay */
.DocSearch-Button-Keys > kbd,
/* The live playground preview can often display dates/counters */
[class*='playgroundPreview'] {
  visibility: hidden;
}

/*
Different docs last-update dates can alter layout
"visibility: hidden" is not enough
 */
.theme-last-updated {
  display: none;
}

/*
Mermaid diagrams are rendered client-side and produce layout shifts
 */
.docusaurus-mermaid-container {
  display: none;
}
```

:::

## Example repository

TODO

https://github.com/slorber/docusaurus-argos-example

https://github.com/slorber/docusaurus-argos-example/pull/2
